services:
  # PostgreSQL - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: algomap
      POSTGRES_USER: algomap
      POSTGRES_PASSWORD: algomap_secret_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/sql/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U algomap"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - algomap-network

  # RabbitMQ - –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"    # AMQP –ø–æ—Ä—Ç
      - "15672:15672"  # Management UI (http://localhost:15672, guest/guest)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - algomap-network

  # =====================================================
  # Backend API –∏ Worker - –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –õ–û–ö–ê–õ–¨–ù–û
  # –°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∏–∂–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
  # =====================================================
  
  # backend-api:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile.api
  #   env_file:
  #     - ./backend/.env.api
  #   ports:
  #     - "8080:8080"
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   networks:
  #     - algomap-network

  # backend-worker:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile.worker
  #   env_file:
  #     - ./backend/.env.worker
  #   volumes:
  #     - worker_data:/data
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   networks:
  #     - algomap-network

  # =====================================================
  # Frontend - –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –õ–û–ö–ê–õ–¨–ù–û
  # Production-—Å–±–æ—Ä–∫–∞ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
  # =====================================================
  
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   ports:
  #     - "3000:80"
  #   depends_on:
  #     - backend-api
  #   networks:
  #     - algomap-network

volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  worker_data:
    driver: local

networks:
  algomap-network:
    driver: bridge

# =====================================================
# –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –õ–û–ö–ê–õ–¨–ù–û–ô –†–ê–ó–†–ê–ë–û–¢–ö–ò
# =====================================================
#
# 1. –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (PostgreSQL + RabbitMQ):
#    docker-compose up -d
#
# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å—ë –ø–æ–¥–Ω—è–ª–æ—Å—å:
#    docker-compose ps
#    
#    RabbitMQ UI: http://localhost:15672 (guest/guest)
#    PostgreSQL: localhost:5432 (algomap/algomap_secret_pass)
#
# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env —Ñ–∞–π–ª—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:
#    
#    backend/.env.api:
#      DATABASE_URL=postgresql://algomap:algomap_secret_pass@localhost:5432/algomap?sslmode=disable
#      RABBITMQ_URL=amqp://guest:guest@localhost:5672/
#      LOG_LEVEL=debug
#      PORT=8080
#
#    backend/.env.worker:
#      DATABASE_URL=postgresql://algomap:algomap_secret_pass@localhost:5432/algomap?sslmode=disable
#      RABBITMQ_URL=amqp://guest:guest@localhost:5672/
#      AT_SQLITE_PATH=./at.db
#      LOG_LEVEL=debug
#
#    frontend/.env:
#      REACT_APP_API_URL=http://localhost:8080/api
#
# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å Backend API (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ):
#    cd backend
#    go run cmd/api/main.go
#
# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å Backend Worker (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ):
#    cd backend
#    go run cmd/worker/main.go
#
# 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å Frontend (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ):
#    cd frontend
#    npm install  # —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
#    npm start
#
# 7. –ì–æ—Ç–æ–≤–æ! üéâ
#    Frontend: http://localhost:3000
#    Backend API: http://localhost:8080
#    RabbitMQ UI: http://localhost:15672
#
# =====================================================
# –û–°–¢–ê–ù–û–í–ö–ê
# =====================================================
#
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:
#   docker-compose down
#
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:
#   docker-compose down -v
#
# =====================================================